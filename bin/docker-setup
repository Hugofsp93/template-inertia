#!/bin/bash
set -e

echo "ğŸš€ Iniciando setup do Docker..."

echo "ğŸ“¦ Construindo as imagens..."
docker compose build

echo "ğŸ”„ Parando containers existentes..."
docker compose down

echo "â–¶ï¸ Iniciando containers em background..."
docker compose up -d

echo "â³ Aguardando PostgreSQL inicializar..."
until docker compose exec db pg_isready -U postgres; do
  echo "ğŸ”„ PostgreSQL estÃ¡ iniciando..."
  sleep 2
done
echo "âœ… PostgreSQL estÃ¡ pronto!"

echo "â³ Aguardando mais 5 segundos para garantir..."
sleep 5

echo "ğŸ—„ï¸ Criando banco de dados..."
if docker compose exec web bundle exec rails db:create 2>/dev/null; then
  echo "âœ… Banco de dados criado com sucesso!"
else
  echo "âš ï¸ Banco de dados jÃ¡ existe ou ocorreu um erro. Tentando prosseguir..."
fi

echo "ğŸ”„ Rodando migraÃ§Ãµes..."
docker compose exec web bundle exec rails db:migrate

echo "ğŸ“¦ Instalando dependÃªncias do Node.js..."
docker compose exec web yarn install

echo "âœ… Setup concluÃ­do! VocÃª pode ver os logs com: docker compose logs -f"

echo "ğŸŒ A aplicaÃ§Ã£o estarÃ¡ disponÃ­vel em: http://localhost:3000"

echo "ğŸš€ Iniciando o servidor..."
docker compose up

echo "ğŸŒ Acesse: http://localhost:3000" 